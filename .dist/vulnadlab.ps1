#Base Lists 
$Global:HumansNames = @('Afonso', 'Alexandra', 'Alberto', 'Alexandre', 'Alice', 'Álvaro', 'Amélia', 'André', 'Ângela', 'António', 'Ariana', 'Artur', 'Beatriz', 'Benedita', 'Bernardo', 'Bruno', 'Carla', 'Carlos', 'Carolina', 'Catarina', 'Célia', 'Cláudia', 'Cristina', 'Daniel', 'Daniela', 'David', 'Diogo', 'Duarte', 'Eduardo', 'Elisa', 'Elvira', 'Emanuel', 'Emília', 'Ernesto', 'Estela', 'Eugénio', 'Eva', 'Fábio', 'Fátima', 'Fernanda', 'Fernando', 'Filipe', 'Francisco', 'Gabriel', 'Gabriela', 'Gaspar', 'Gil', 'Gonçalo', 'Guilherme', 'Helena', 'Henrique', 'Hugo', 'Inês', 'Irene', 'Isabel', 'Isabela', 'Joana', 'João', 'Joaquim', 'Jorge', 'José', 'Juliana', 'Júlia', 'Júlio', 'Leonor', 'Letícia', 'Lídia', 'Lígia', 'Lourenço', 'Luana', 'Luís', 'Luísa', 'Madalena', 'Manuel', 'Manuela', 'Margarida', 'Mariana', 'Mário', 'Marta', 'Matilde', 'Miguel', 'Mónica', 'Nádia', 'Nuno', 'Olga', 'Óscar', 'Patrícia', 'Paula', 'Pedro', 'Raquel', 'Rita', 'Rodrigo', 'Rosa', 'Rui', 'Salvador', 'Samuel', 'Sandra', 'Sara', 'Sebastião', 'Sérgio', 'Simão', 'Sofia', 'Susana', 'Telma', 'Teresa', 'Tomás', 'Valentina', 'Vasco', 'Vera', 'Vicente', 'Vitória', 'Vítor', 'Adriana', 'Adriano', 'Agostinho', 'Aida', 'Aldo', 'Alina', 'Alípio', 'Almerinda', 'Américo', 'Ana', 'Anabela', 'Anastácia', 'Ângelo', 'Aníbal', 'Anita', 'Antónia', 'Armando', 'Arnaldo', 'Aurora', 'Balbina', 'Baltazar', 'Bartolomeu', 'Bento', 'Berta', 'Caetana', 'Caetano', 'Camila', 'Cândida', 'Cândido', 'Carmo', 'César', 'Cidália', 'Cipriano', 'Cláudio', 'Conceição', 'Constança', 'Cristiano', 'Custódia', 'Damião', 'Débora', 'Delfim', 'Diana', 'Dinís', 'Domingos', 'Dora', 'Dulce', 'Edgar', 'Edite', 'Eduarda', 'Eliana', 'Elisabete', 'Eliseu', 'Ema', 'Emílio', 'Ermelinda', 'Esmeralda', 'Estêvão', 'Etelvina', 'Eugénia', 'Eurico', 'Eva', 'Evelina', 'Fausto', 'Filomena', 'Flávio', 'Flor', 'Frederico', 'Genoveva', 'Gertrudes', 'Gilberto', 'Gisela', 'Graciete', 'Gregório', 'Gustavo', 'Hélder', 'Hermínia', 'Horácio', 'Hortense', 'Horácio', 'Idalina', 'Ilídio', 'Irina', 'Isaac', 'Ivone', 'Jacinta', 'Joaquina', 'Judite', 'Julieta', 'Jussara', 'Lara', 'Laurinda', 'Lauro', 'Leandro', 'Lígia', 'Lina', 'Lourdes', 'Lúcio', 'Mafalda', 'Mara', 'Márcia', 'Marcelino', 'Marco', 'Marcos', 'Marisa', 'Máxima', 'Maximino', 'Melânia', 'Micaela', 'Milene', 'Moisés', 'Natália', 'Nelson', 'Nestor', 'Neuza', 'Nicole', 'Nídia', 'Norberto', 'Octávio', 'Odete', 'Olavo', 'Orlando', 'Paloma', 'Pascoal', 'Patrício', 'Paulina', 'Piedade', 'Pilar', 'Quim', 'Raimundo', 'Rebeca', 'Remédios', 'Renato', 'Ricardo', 'Roberto', 'Rodolfo', 'Rosário', 'Rubina', 'Salomé', 'Saraiva', 'Sebastião', 'Selma', 'Silvano', 'Sílvio', 'Silvina', 'Tadeu', 'Tânia', 'Teodora', 'Teodoro', 'Tobias', 'Ulisses', 'Valdemar', 'Vanda', 'Verónica', 'Violeta', 'Virgílio', 'Wilma', 'Xavier', 'Yara', 'Yolanda', 'Zacarias', 'Zélia', 'Zita', 'Zulmira')
$Global:BadPasswords = @('123456', 'password', '123456789', '12345678', '12345', '1234567', 'qwerty', 'abc123', 'password1', '111111', '123123', 'admin', 'letmein', 'welcome', 'monkey', '1234', 'sunshine', 'iloveyou', '000000', 'princess', 'qwerty123', 'baseball', 'superman', 'football', 'shadow', 'batman', 'trustno1', '654321', '123321', 'qazwsx', 'password123', '1q2w3e4r', 'master', '1qaz2wsx', 'freedom', 'whatever', 'trustme', 'starwars', 'abc123456', 'hello123', 'michael', 'charlie', 'aa123456', 'ashley', 'soccer', 'monkey123', 'cheese', 'pokemon', 'harley', 'jessica', 'maggie', 'biteme', 'matrix', 'jordan', 'hunter', 'buster', 'qwe123', 'computer', 'jordan23', 'tigger', '123qwe', 'summer', 'daniel', 'andrew', 'bubbles', 'asdfgh', 'iloveyou1', 'snoopy', 'ginger', 'michelle', 'peanut', 'merlin', 'qwerty1', 'fuckyou', 'taylor', 'purple', 'orange', 'pepper', 'bear', 'cheater', 'secret', 'hannah', 'cameron', 'samsung', 'killer', 'hunter1', 'cookie', 'george', 'harry', 'maverick', 'banana', 'passw0rd', 'testing', 'loveme', 'dragon', 'friends', 'happy', 'banana1', 'muffin', 'blessed', 'scooby', 'pepper1', 'hardcore', 'whatever1', 'hockey', 'rainbow', 'fluffy', 'snowball', 'mustang', 'ginger1', 'pass123', 'babygirl', 'candy', 'chicken', 'sparkle', 'blowme', 'amanda', 'guitar', 'asdf1234', 'yankees', 'peaches', 'samantha', 'jasper', 'brazil', 'mylove', 'college', 'hottie', 'blink182', 'tigers', 'zxcvbnm', 'steven', 'dakota', 'password!', 'batman1', 'ashley1', 'godzilla', 'scooter', 'peach', 'liverpool', 'purple1', '123asd', 'justin', 'cookie1', 'kitten', 'crazy', 'superstar', 'angel', 'warrior', 'michael1', 'elvis', 'ninja', 'qweasd', 'flower', 'lightning', 'sexy', 'roses', 'sunshine1', 'rangers', 'simpsons', 'hannah1', 'wildcat', 'frank', 'popcorn', 'rainbow1', 'joker', 'sophie', 'testing123', 'sexymama', 'nicole', 'racing', 'passpass', 'robert', 'test1234', 'lasvegas', 'buddy', 'motorola', 'chevy', 'volvo', 'camaro', 'panther', 'silver', 'boomer', 'mercedes', 'winner', 'swordfish', 'magnum', 'hotdog', 'george1', 'titanic', 'killer1', 'testtest', 'flower1', 'love123', 'secret1', 'justin1', 'chicken1', 'darkness', 'america', 'striker', 'sexylady', 'please', 'tester', 'captain', 'summer1', 'batmobile', 'windows', 'hockey1', 'phoenix', '123abc', 'muffin1', 'happydays', 'natasha', '123batman', 'lovebug', 'hunter2', 'sweety', 'cocacola', 'winter', 'jackson', 'terminator', 'jesus1', 'red123', 'secret123', 'eminem', 'hawaii', 'fishing', 'infinity', 'soccer1', 'katie', 'jenny', 'flower123')
$Global:Groups = @('Office Admin','IT Admins','Executives','Senior management','Project management','IT Helpdesk','Marketing','Sales','Accounting');
$Global:HighGroups = @('Office Admin','IT Admins','Executives');
$Global:MidGroups = @('Senior management','Project management','IT Helpdesk');
$Global:NormalGroups = @('Marketing','Sales','Accounting');
$Global:OfficeAdmin = @();
$Global:ITAdmins = @();
$Global:Executives = @();
$Global:Seniormanagement = @();
$Global:Projectmanagement = @();
$Global:ITHelpdesk = @();
$Global:Marketing = @();
$Global:Sales = @();
$Global:Accounting = @();
$Global:ACLperm = @('GenericAll','GenericWrite','WriteOwner','WriteDACL','Self');
$Global:ServicesAccountsAndSPNs = @('mssql_svc,mssqlserver','http_svc,httpserver','exchange_svc,exserver');
$Global:InitialAccessUsers = @();
$Global:CreatedUsers = @();
$Global:RemainingUsers = @();
$Global:ACLUser = "";
$Global:AllObjects = @();
$Global:Domain = "";
#Strings 
$Global:Spacing = "`t"
$Global:PlusLine = "`t[+]"
$Global:ErrorLine = "`t[-]"
$Global:InfoLine = "`t[*]"
function Write-Good { param( $String ) Write-Host $Global:PlusLine  $String -ForegroundColor 'Green'}
function Write-Bad  { param( $String ) Write-Host $Global:ErrorLine $String -ForegroundColor 'red'  }
function Write-Info { param( $String ) Write-Host $Global:InfoLine $String -ForegroundColor 'gray'; echo $String >> generate.log }
function ShowBanner {
    $banner  = @()
    $banner+= $Global:Spacing + ''
    $banner+= $Global:Spacing + '¦¦+   ¦¦+¦¦+   ¦¦+¦¦+     ¦¦¦+   ¦¦+ ¦¦¦¦¦+ ¦¦¦¦¦¦+     ¦¦+'
    $banner+= $Global:Spacing + '¦¦¦   ¦¦¦¦¦¦   ¦¦¦¦¦¦     ¦¦¦¦+  ¦¦¦¦¦+--¦¦+¦¦+--¦¦+    ¦¦¦'
    $banner+= $Global:Spacing + '¦¦¦   ¦¦¦¦¦¦   ¦¦¦¦¦¦     ¦¦+¦¦+ ¦¦¦¦¦¦¦¦¦¦¦¦¦¦  ¦¦¦¦¦¦¦¦¦¦¦¦¦¦'
    $banner+= $Global:Spacing + '+¦¦+ ¦¦++¦¦¦   ¦¦¦¦¦¦     ¦¦¦+¦¦+¦¦¦¦¦+--¦¦¦¦¦¦  ¦¦¦+---¦¦+---+'
    $banner+= $Global:Spacing + ' +¦¦¦¦++ +¦¦¦¦¦¦++¦¦¦¦¦¦¦+¦¦¦ +¦¦¦¦¦¦¦¦  ¦¦¦¦¦¦¦¦¦++    ¦¦¦'
    $banner+= $Global:Spacing + '  +---+   +-----+ +------++-+  +---++-+  +-++-----+     +-+'
    $banner+= $Global:Spacing + ''                                                     
    $banner+= $Global:Spacing + 'By MF -- @CyberS3c'
    $banner | foreach-object {
        Write-Host $_ -ForegroundColor (Get-Random -Input @('Green','Cyan','Yellow','gray','white'))
    }                             
}
function VulnAD-GetRandom {
   Param(
     [array]$InputList
   )
   return Get-Random -InputObject $InputList
}

function VulnAD-AddADUser {
    Param(
        [int]$limit = 1
    )
    Add-Type -AssemblyName System.Web
    for ($i=1; $i -le $limit; $i=$i+1 ) {
        $firstname = (VulnAD-GetRandom -InputList $Global:HumansNames);
        $lastname = (VulnAD-GetRandom -InputList $Global:HumansNames);
        $fullname = "{0} {1}" -f ($firstname , $lastname);
        $SamAccountName = ("{0}.{1}" -f ($firstname, $lastname)).ToLower();
        $principalname = "{0}.{1}" -f ($firstname, $lastname);
        $generated_password = ([System.Web.Security.Membership]::GeneratePassword(7,2))
        Write-Info "Creating $SamAccountName User"
        Try { New-ADUser -Name "$firstname $lastname" -GivenName $firstname -Surname $lastname -SamAccountName $SamAccountName -UserPrincipalName $principalname@$Global:Domain -AccountPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}
        $Global:CreatedUsers += $SamAccountName;
        $Global:RemainingUsers += $SamAccountName;
    }
}
function VulnAD-AddADGroup {
    Param(
        [array]$GroupList
    )
    $noOfGroup = [Math]::Floor($Global:CreatedUsers.length/30)
    $Users = $Global:CreatedUsers.length - 30*$noOfGroup
    foreach ($group in $GroupList) {
        Write-Info "Creating $group Group"
        Try { New-ADGroup -name $group -GroupScope Global } Catch {}
        if (@(Compare-Object $GroupList $Global:HighGroups -SyncWindow 0).Length -eq 0){
            $noOfUsers = $noOfGroup*2
        }
        elseif (@(Compare-Object $GroupList $Global:MidGroups -SyncWindow 0).Length -eq 0){
            if ($Users -ge 15){
                $noOfUsers = [Math]::Floor(($Global:CreatedUsers.length-(($noOfGroup+1)*15)-($noOfGroup*6))/3)
            }
            else {
                $noOfUsers = $noOfGroup*3
            }
        }
        elseif (@(Compare-Object $GroupList $Global:NormalGroups -SyncWindow 0).Length -eq 0){
            if ($Users -lt 30 -and $Users -gt 15){
                $noOfUsers = [Math]::Floor(($noOfGroup+1)*15/3)
            }
            elseif ($Users -le 15 -and $Users -ne 0){
                $noOfUsers = [Math]::Floor(($noOfGroup*15+$Users)/3)
            }
            else {
                $noOfUsers = $noOfGroup*5
            }
        }
        for ($i=1; $i -le $noOfUsers; $i=$i+1 ) {
            $randomuser = (VulnAD-GetRandom -InputList $Global:RemainingUsers)
            Write-Info "Adding $randomuser to $group"

            Try { Add-ADGroupMember -Identity $group -Members $randomuser } Catch {}
            if ($group -eq "Office Admin"){ $Global:OfficeAdmin += $randomuser}
            elseif ($group -eq "IT Admins"){ $Global:ITAdmins += $randomuser}
            elseif ($group -eq "Executives"){ $Global:Executives += $randomuser}
            elseif ($group -eq "Senior management"){ $Global:Seniormanagement += $randomuser}
            elseif ($group -eq "Project management"){ $Global:Projectmanagement += $randomuser}
            elseif ($group -eq "IT Helpdesk"){ $Global:ITHelpdesk += $randomuser}
            elseif ($group -eq "Marketing"){ $Global:Marketing += $randomuser}
            elseif ($group -eq "Sales"){ $Global:Sales += $randomuser}
            elseif ($group -eq "Accounting"){ $Global:Accounting += $randomuser}
            $Global:RemainingUsers = $Global:RemainingUsers -ne $randomuser
        }
        $Global:AllObjects += $group;
    }
    Try {Add-ADGroupMember -Identity "Domain Admins" -Members "IT Admins"} Catch{}
}
function VulnAD-AddACL {
        [CmdletBinding()]
        param(
            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Destination,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [System.Security.Principal.IdentityReference]$Source,

            [Parameter(Mandatory=$true)]
            [ValidateNotNullOrEmpty()]
            [string]$Rights

        )
        $ADObject = [ADSI]("LDAP://" + $Destination)
        $identity = $Source
        $adRights = [System.DirectoryServices.ActiveDirectoryRights]$Rights
        $type = [System.Security.AccessControl.AccessControlType] "Allow"
        $inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "All"
        $ACE = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$inheritanceType
        $ADObject.psbase.ObjectSecurity.AddAccessRule($ACE)
        $ADObject.psbase.commitchanges()
}
function VulnAD-Acls {
    foreach ($abuse in $Global:Badperm) {
        $ngroup = VulnAD-GetRandom -InputList $Global:MidGroups
        $mgroup = VulnAD-GetRandom -InputList $Global:NormalGroups
        $SrcGroup = Get-ADGroup -Identity $mgroup
        $DstGroup = Get-ADGroup -Identity $ngroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "ACL $mgroup has $abuse permission for $ngroup"
    }
    foreach ($abuse in $Global:Badperm) {
        $hgroup = VulnAD-GetRandom -InputList $Global:HighGroups
        $mgroup = VulnAD-GetRandom -InputList $Global:MidGroups
        $SrcGroup = Get-ADGroup -Identity $hgroup
        $DstGroup = Get-ADGroup -Identity $mgroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "ACL $hgroup has $abuse permission for $mgroup"
    }
    foreach ($abuse in $Global:Badperm) {
        $hgroup = VulnAD-GetRandom -InputList $Global:HighGroups
        $ngroup = VulnAD-GetRandom -InputList $Global:NormalGroups
        $SrcGroup = Get-ADGroup -Identity $hgroup
        $DstGroup = Get-ADGroup -Identity $ngroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "ACL $hgroup has $abuse permission for $ngroup"
    }
}
function VulnAD-Kerberoasting {
    foreach ($sv in $Global:ServicesAccountsAndSPNs) {
        if ($selected_service -ne $sv) {
            $svc = $sv.split(',')[0];
            $spn = $sv.split(',')[1];
            if ((Get-Random -Maximum 2)){
				$password = VulnAD-GetRandom -InputList $Global:BadPasswords;
            }else{
				$password = ([System.Web.Security.Membership]::GeneratePassword(7,2))
            }
            Try { New-ADUser -Name $svc -SamAccountName $svc -ServicePrincipalNames "$svc/$spn.$Global:Domain" -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}
			$randomgroup = (VulnAD-GetRandom -InputList $Global:MidGroups)
			Add-ADGroupMember -Identity $randomgroup -Members $svc
			Write-Info "Creating $svc services account"
			Write-Info "$svc in $randomgroup"
        }
    }
}
function VulnAD-ASREPRoasting {
    for ($i=1; $i -le (Get-Random -Minimum 1 -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList (Get-Random -InputObject @($Global:Marketing, $Global:Sales, $Global:Accounting)))
        $password = VulnAD-GetRandom -InputList $Global:BadPasswords;
        Set-AdAccountPassword -Identity $randomuser -Reset -NewPassword (ConvertTo-SecureString $password -AsPlainText -Force)
        Set-ADAccountControl -Identity $randomuser -DoesNotRequirePreAuth 1
        Write-Info "AS-REPRoasting $randomuser"
        $Global:InitialAccessUsers += $randomuser;
    }
}
function VulnAD-DnsAdmins {
	Set-ADGroup -Identity "DnsAdmins" -GroupScope Universal
	Set-ADGroup -Identity "DnsAdmins" -GroupScope Global
    Add-Type -AssemblyName System.Web

    $firstname = (VulnAD-GetRandom -InputList $Global:HumansNames);
    $lastname = (VulnAD-GetRandom -InputList $Global:HumansNames);
    $fullname = "{0} {1}" -f ($firstname , $lastname);
    $SamAccountName = ("{0}.{1}" -f ($firstname, $lastname)).ToLower();
    $principalname = "{0}.{1}" -f ($firstname, $lastname);
    $password = "UberSecurePassword"
    Try { New-ADUser -Name "$firstname $lastname" -GivenName $firstname -Surname $lastname -SamAccountName $SamAccountName -UserPrincipalName $principalname@$Global:Domain -AccountPassword (ConvertTo-SecureString $password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}

    Add-ADGroupMember -Identity "DnsAdmins" -Members $SamAccountName
    Set-ADUser $SamAccountName -Description "DNS Admin"
    Write-Info "DnsAdmins : $SamAccountName"
}
function VulnAD-DefaultPassword
 {
    for ($i=1; $i -le (Get-Random -Minimum 1 -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList (Get-Random -InputObject @($Global:Marketing, $Global:Sales, $Global:Accounting)))
        $password = ([System.Web.Security.Membership]::GeneratePassword(7,2))
        Set-AdAccountPassword -Identity $randomuser -Reset -NewPassword (ConvertTo-SecureString $password -AsPlainText -Force)
        Set-ADUser $randomuser -Description "New user generated password: $password" -ChangePasswordAtLogon $true
        Write-Info "Password in Description : $randomuser $password"
        $Global:InitialAccessUsers += $randomuser;
    }
}
function VulnAD-PasswordSpraying {
    $same_password = ($Global:Domain -replace "\.\w+", "")+([string](Get-Random -Maximum 100)).PadLeft(3, '0')
    for ($i=1; $i -le (Get-Random -Minimum 2 -Maximum 6); $i=$i+1 ) {
        $randomuser = (VulnAD-GetRandom -InputList (Get-Random -InputObject @($Global:Marketing, $Global:Sales, $Global:Accounting)))
        Set-AdAccountPassword -Identity $randomuser -Reset -NewPassword (ConvertTo-SecureString $same_password -AsPlainText -Force)
        Set-ADUser $randomuser -Description "Company default password(Reset ASAP)" -ChangePasswordAtLogon $true
        Write-Info "Same Password (Password Spraying) : $randomuser"
        $Global:InitialAccessUsers += $randomuser;
    }
}
function Counter{
    param(
        [string]$path
    )
    $counter = @{};
    foreach ($letter in [char[]]$path){
        $letter = [string]$letter
        if (-not $counter.Contains($letter)){
            $counter[$letter] =  0
        }
        $counter[$letter] += 1
    }
    return $counter
}
function getList{
    param(
        [string]$path,
        [array]$list
    )
    $r = 0
    $newlist = [System.Collections.ArrayList]::new()
    foreach ($o in $list)
    {
        $newlist.add($o)
        
    }
    $mapping = @("Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "IT Admins", "Executives")
    foreach ($i in (Counter($path)).keys){
        if ((Counter($path))[$i] -ge 2){
            foreach ($j in (Counter($path)).keys){
                $newlist.remove($mapping[$j-1])
            }
        }
    }
    return $newlist
}
function getPath{
    $mapping = @{"Marketing" = "1"; "Sales" = "2"; "Accounting" = "3"; "Senior management" = "4"; "Project management" = "5"; "IT Helpdesk" = "6"; "Office Admin" = "7"; "IT admins" = "8"; "Executives" = "9";}
    $path = ""
    $path2 = ""
    $end = VulnAD-GetRandom -InputList $Global:HighGroups
    $middle = VulnAD-GetRandom -InputList $Global:MidGroups
    $start = VulnAD-GetRandom -InputList $Global:NormalGroups
    $path += $mapping[$start]
    $path2 += $mapping[$middle]
    if ((Get-Random -Maximum 2)){
        while ($path[-1] -ne $mapping[$end]){
            $path += $mapping[(VulnAD-GetRandom -InputList (getList -path $path -list ($Global:NormalGroups+$end)))]
        }
        Write-Info "Path: $path"
        return $path
    }
    else{
        while ($path[-1] -ne $mapping[$middle]){
            $path += $mapping[(VulnAD-GetRandom -InputList (getList -path $path -list ($Global:NormalGroups+$middle)))]
        }
        while ($path2[-1] -ne $mapping[$end]){
            $path2 += $mapping[(VulnAD-GetRandom -InputList (getList -path ($path+$path2) -list ($Global:MidGroups+$end)))]
        }
        Write-Info "Path: $path$path2"
        return $path+$path2
    }
}
function VulnAD-UserAcl{
    param(
        [string]$src,
        [string]$dst
    )
    $mapping = @("","Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "It Admins", "Executives")
    $firstname = (VulnAD-GetRandom -InputList $Global:HumansNames);
    $lastname = (VulnAD-GetRandom -InputList $Global:HumansNames);
    $fullname = "{0} {1}" -f ($firstname , $lastname);
    $SamAccountName = ("{0}.{1}" -f ($firstname, $lastname)).ToLower();
    $principalname = "{0}.{1}" -f ($firstname, $lastname);
    $generated_password = ([System.Web.Security.Membership]::GeneratePassword(7,2))
    Try { New-ADUser -Name "$firstname $lastname" -GivenName $firstname -Surname $lastname -SamAccountName $SamAccountName -UserPrincipalName $principalname@$Global:Domain -AccountPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}
    Try { Add-ADGroupMember -Identity $mapping[$dst] -Members $SamAccountName } Catch {}
    if ($Global:ACLUser){
        $SrcUser = Get-ADUser -identity $Global:ACLUser
    }
    else {
        $SrcUser = Get-ADUser -identity (VulnAD-GetRandom -InputList $Global:InitialAccessUsers)
        $Global:InitialAccessUsers = $Global:InitialAccessUsers -ne $SrcUser
    }
    $DstUser = Get-ADUser -identity $SamAccountName
    $Global:ACLUser = Get-ADUser -identity $SamAccountName
    if ($True){
        VulnAD-AddACL -Source $SrcUser.sid -Destination $DstUser.DistinguishedName -Rights "GenericAll"
        Write-Info ("Giving "+$SrcUser.Name+" GenericAll over "+$DstUser.Name+"("+$mapping[$dst]+")")
    }
    else{
        # Figure out how to add User-Force-Change-Password
        # VulnAD-AddACL -Source $SrcUser -Destination $DstUser.DistinguishedName -Rights "User-Force-Change-Password"
        Write-Info "Giving $SrcUser.Name User-Force-Change-Password over $DstUser.Name"
    }
}
function VulnAD-GroupUserAcl{
    param(
        [string]$src,
        [string]$dst
    )
    $mapping = @("","Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "It Admins", "Executives")

    $firstname = (VulnAD-GetRandom -InputList $Global:HumansNames);
    $lastname = (VulnAD-GetRandom -InputList $Global:HumansNames);
    $fullname = "{0} {1}" -f ($firstname , $lastname);
    $SamAccountName = ("{0}.{1}" -f ($firstname, $lastname)).ToLower();
    $principalname = "{0}.{1}" -f ($firstname, $lastname);
    $generated_password = ([System.Web.Security.Membership]::GeneratePassword(7,2))
    Try { New-ADUser -Name "$firstname $lastname" -GivenName $firstname -Surname $lastname -SamAccountName $SamAccountName -UserPrincipalName $principalname@$Global:Domain -AccountPassword (ConvertTo-SecureString $generated_password -AsPlainText -Force) -PassThru | Enable-ADAccount } Catch {}
    Try { Add-ADGroupMember -Identity $mapping[$dst] -Members $SamAccountName } Catch {}

    $SrcGroup = Get-ADGroup -Identity $mapping[$src]
    $DstUser = Get-ADUser -identity $SamAccountName
    $Global:ACLUser = Get-ADUser -identity $SamAccountName
    if ($True){
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstUser.DistinguishedName -Rights "GenericAll"
        Write-Info ("Giving "+$SrcGroup.Name+" GenericAll over "+$DstUser.Name+"("+$mapping[$dst]+")")
    }
    else{
        # Figure out how to add User-Force-Change-Password
        # VulnAD-AddACL -Source $SrcUser -Destination $DstUser.DistinguishedName -Rights "User-Force-Change-Password"
        Write-Info "Giving $SrcUser.Name User-Force-Change-Password over $DstUser.Name"
    }
}
function VulnAD-UserGroupAcl{
    param(
        [string]$dst
    )
    $mapping = @("","Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "It Admins", "Executives")

    $DstGroup = Get-ADGroup -Identity $mapping[$dst]
    if ($True){
        VulnAD-AddACL -Source $Global:ACLUser.sid -Destination $Dstgroup.DistinguishedName -Rights "GenericAll"
        Write-Info ("Giving "+$Global:ACLUser.Name+" GenericAll over "+$Dstgroup.Name)
    }
    else{
        # Figure out how to add User-Force-Change-Password
        # VulnAD-AddACL -Source $SrcUser -Destination $DstUser.DistinguishedName -Rights "User-Force-Change-Password"
        Write-Info "Giving $SrcUser.Name User-Force-Change-Password over $DstUser.Name"
    }
}
function VulnAD-GroupAcl{
    param(
        [string]$src,
        [string]$dst
    )
    $mapping = @("","Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "It Admins", "Executives")
    $SrcGroup = Get-ADGroup -Identity $mapping[$src]
    $DstGroup = Get-ADGroup -Identity $mapping[$dst]
    $abuse = Get-Random -InputObject @('GenericAll', 'WriteProperty', 'Self', 'WriteOwner', 'DoublePerm')
    if ($abuse -eq "DoublePerm"){
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights "WriteDACL"
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights "WriteOwner"
        Write-Info ("Giving "+$SrcGroup.Name+" WriteDACL & WriteOwner over "+$DstGroup.Name)
    }
    else {
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info ("Giving "+$SrcGroup.Name+" "+$abuse+" over "+$DstGroup.Name)
    }
}
function VulnAD-BadAcls {
    $mapping = @($Global:Marketing, $Global:Sales, $Global:Accounting, $Global:Seniormanagement, $Global:Projectmanagement, $Global:ITHelpdesk, $Global:OfficeAdmin, $Global:ITAdmins, $Global:Executives)
    $path = getPath
    if ($path[0] -eq $path[1]){
        $DstUser = Get-ADUser -identity (VulnAD-GetRandom -InputList ($mapping[[string]$path[1]-1]))
        if ($True){
            $InitialUser = Get-ADUser -identity (VulnAD-GetRandom -InputList $Global:InitialAccessUsers)
            $Global:InitialAccessUsers = $Global:InitialAccessUsers -ne $InitialUser
            $Global:ACLUser = Get-ADUser -identity $DstUser
            VulnAD-AddACL -Source $InitialUser.sid -Destination $DstUser.DistinguishedName -Rights "GenericAll"
            Write-Info ("Giving "+$InitialUser.Name+" GenericAll over "+$DstUser.Name)
        }
        else{
            # Figure out how to add User-Force-Change-Password
            # VulnAD-AddACL -Source $SrcUser -Destination $DstUser.DistinguishedName -Rights "User-Force-Change-Password"
            Write-Info "Giving $SrcUser.Name User-Force-Change-Password over $DstUser.Name"
        }
    }
    else{
        $mapping = @("Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "It Admins", "Executives")
        $SrcGroup = Get-ADGroup -Identity $mapping[[string]$path[0]]
    }
    $count = 0
    $Duplicates = @()
    foreach ($i in (Counter($path)).keys){
        if ((Counter($path))[$i] -ge 2){
            $Duplicates += $i
        }
    }
    $DupPosition = @()
    $DupPosition2 = @()
    foreach ($i in $Duplicates){
        $DupPosition += [string]$path.LastIndexOf($i)
    }
    foreach ($i in $Duplicates){
        $DupPosition2 += [string]($path.LastIndexOf($i)+2)
    }
    $intersect = $DupPosition | ?{$DupPosition2 -contains $_}
    foreach ($num in [char[]]$path[1..(([char[]]$path).Count-1)]){
        $count++
        if([string]$path[[string]$count-1] -eq [string]$path[$count] -or $intersect -eq $count+1){
            VulnAD-UserAcl -src ([string]$path[[string]$count-1]) -dst ([string]$path[$count])
        }
        elseif ($DupPosition.Contains([string]$count)){
            VulnAD-GroupUserAcl -src ([string]$path[[string]$count-1]) -dst ([string]$path[$count])
        }
        elseif ($DupPosition2.Contains([string]($count+1))){
            VulnAD-UserGroupAcl -dst ([string]$path[$count])
        }
        else{
            VulnAD-GroupAcl -src ([string]$path[[string]$count-1]) -dst ([string]$path[$count])
        }

    }
    $mapping = @("Marketing", "Sales", "Accounting", "Senior management", "Project management", "IT Helpdesk", "Office Admin", "It Admins", "Executives")
    VulnAD-DCSync -group ($mapping[([string]$path[-1]-1)])

    foreach ($abuse in $Global:ACLperm) {
        $hgroup = VulnAD-GetRandom -InputList $Global:HighGroups
        $mgroup = VulnAD-GetRandom -InputList $Global:MidGroups
        $DstGroup = Get-ADGroup -Identity $hgroup
        $SrcGroup = Get-ADGroup -Identity $mgroup
        VulnAD-AddACL -Source $SrcGroup.sid -Destination $DstGroup.DistinguishedName -Rights $abuse
        Write-Info "BadACL $hgroup has $abuse permission for $mgroup"
    }
    for ($i=1; $i -le (Get-Random -Minimum 10 -Maximum 30); $i=$i+1 ) {
        $abuse = (VulnAD-GetRandom -InputList $Global:ACLperm);
        $randomuser = VulnAD-GetRandom -InputList $Global:CreatedUsers
        $randomgroup = VulnAD-GetRandom -InputList $Global:AllObjects
        if ((Get-Random -Maximum 2)){
            $Dstobj = Get-ADUser -Identity $randomuser
            $Srcobj = Get-ADGroup -Identity $randomgroup
        }else{
            $Srcobj = Get-ADUser -Identity $randomuser
            $Dstobj = Get-ADGroup -Identity $randomgroup
        }
        VulnAD-AddACL -Source $Srcobj.sid -Destination $Dstobj.DistinguishedName -Rights $abuse 
        Write-Info "BadACL $randomgroup has $abuse permission for $randomuser"
    }
    for ($i=1; $i -le (Get-Random -Minimum 1 -Maximum 30); $i=$i+1 ) {
        $abuse = (VulnAD-GetRandom -InputList $Global:ACLperm);
        $randomuser = VulnAD-GetRandom -InputList $Global:CreatedUsers
        $randomuser2 = VulnAD-GetRandom -InputList $Global:CreatedUsers
        If(-not($randomuser -eq $randomuser2)){
        $Dstobj = Get-ADUser -Identity $randomuser
        $Srcobj = Get-ADUser -Identity $randomuser2
        VulnAD-AddACL -Source $Srcobj.sid -Destination $Dstobj.DistinguishedName -Rights $abuse 
        Write-Info "BadACL $randomuser has $abuse permission for $randomuser2"
        }
    }
}
function VulnAD-DCSync {
    param(
        [string]$group
    )
    $Identity  = (Get-ADGroup -Identity $group)
    $RootDSE = [ADSI]"LDAP://RootDSE"
    $DefaultNamingContext = $RootDse.defaultNamingContext
    $ConfigurationNamingContext = $RootDse.configurationNamingContext
    $UserPrincipal = New-Object Security.Principal.NTAccount("$Identity")

    DSACLS "$DefaultNamingContext" /G "$($UserPrincipal):CA;Replicating Directory Changes" | Out-Null
    DSACLS "$ConfigurationNamingContext" /G "$($UserPrincipal):CA;Replicating Directory Changes" | Out-Null
    
    DSACLS "$DefaultNamingContext" /G "$($UserPrincipal):CA;Replicating Directory Changes All" | Out-Null
    DSACLS "$ConfigurationNamingContext" /G "$($UserPrincipal):CA;Replicating Directory Changes All" | Out-Null
    
    DSACLS "$DefaultNamingContext" /G "$($UserPrincipal):CA;Replicating Directory Changes In Filtered Set" | Out-Null
    DSACLS "$ConfigurationNamingContext" /G "$($UserPrincipal):CA;Replicating Directory Changes In Filtered Set" | Out-Null
    Write-Info "Giving DCSync to : $group"
}
function VulnAD-DisableSMBSigning {
        Set-SmbClientConfiguration -RequireSecuritySignature 0 -EnableSecuritySignature 0 -Confirm -Force
}

function VulnAD-EnableWinRM {
	Enable-PSRemoting -Force
	Set-Item wsman:\localhost\client\trustedhosts * -Force
	#(Get-PSSessionConfiguration -Name "Microsoft.PowerShell").SecurityDescriptorSDDL
	Set-PSSessionConfiguration -Name "Microsoft.PowerShell" -SecurityDescriptorSddl "O:NSG:BAD:P(A;;GA;;;BA)(A;;GA;;;WD)(A;;GA;;;IU)S:P(AU;FA;GA;;;WD)(AU;SA;GXGW;;;WD)"
}

function VulnAD-AnonymousLDAP {
	$Dcname = Get-ADDomain | Select-Object -ExpandProperty DistinguishedName
	$Adsi = 'LDAP://CN=Directory Service,CN=Windows NT,CN=Services,CN=Configuration,' + $Dcname
	$AnonADSI = [ADSI]$Adsi
	$AnonADSI.Put("dSHeuristics","0000002")
	$AnonADSI.SetInfo()
	$ADSI = [ADSI]('LDAP://CN=Users,' + $Dcname)
	$Anon = New-Object System.Security.Principal.NTAccount("ANONYMOUS LOGON")
	$SID = $Anon.Translate([System.Security.Principal.SecurityIdentifier])
	$adRights = [System.DirectoryServices.ActiveDirectoryRights] "GenericRead"
	$type = [System.Security.AccessControl.AccessControlType] "Allow"
	$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "All"
	$ace = New-Object System.DirectoryServices.ActiveDirectoryAccessRule $SID,$adRights,$type,$inheritanceType
	$ADSI.PSBase.ObjectSecurity.ModifyAccessRule([System.Security.AccessControl.AccessControlModification]::Add,$ace,[ref]$false)
	$ADSI.PSBase.CommitChanges()
}

function VulnAD-PublicSMBShare {
	mkdir C:\Common
    echo "$password = ConvertTo-SecureString 'UberSecurePassword' -AsPlainText -Force`n$credential = New-Object System.Management.Automation.PSCredential ('administrator', $password)`nInvoke-Command -ComputerName . -Credential $credential -ScriptBlock { Restart-Service -Name 'DNS Server' }" > C:\Common\DNSrestart.ps1
	New-SmbShare -Name Common -Path C:\Common -FullAccess Everyone
	Enable-LocalUser -Name "Guest"
	$acl = Get-Acl C:\Common
	$AccessRule = New-Object System.Security.AccessControl.FileSystemAccessRule("Guest","FullControl","Allow")
	$acl.SetAccessRule($AccessRule)
	$acl | Set-Acl C:\Common
	Set-Itemproperty -path 'HKLM:\SYSTEM\CurrentControlSet\Control\Lsa' -Name 'EveryoneIncludesAnonymous' -value '1'
	New-ItemProperty -Path 'HKLM:\SYSTEM\CurrentControlSet\Services\LanmanServer\Parameters' -name "NullSessionShares" -PropertyType MultiString -value "C:\Common"
}

function VulnAD-FirewallOff {
	netsh advfirewall set allprofiles state off
} 

function Invoke-VulnAD {
    Param(
        [int]$UsersLimit = 100,
        [Parameter(Mandatory=$True,ValueFromPipeline=$True,ValueFromPipelineByPropertyName=$True,Position=1)]
        [ValidateNotNullOrEmpty()]
        [System.String]
        $DomainName
    )
    ShowBanner
    $Global:Domain = $DomainName
    Set-ADDefaultDomainPasswordPolicy -Identity $Global:Domain -LockoutDuration 00:01:00 -LockoutObservationWindow 00:01:00 -ComplexityEnabled $false -ReversibleEncryptionEnabled $False -MinPasswordLength 4
    if ($UsersLimit -lt 30) {
        Write-Output "Setting minimum 30 users"
        $UsersLimit = 30
    }
    VulnAD-AddADUser -limit $UsersLimit
    Write-Good "Users Created"
    VulnAD-AddADGroup -GroupList $Global:HighGroups
    Write-Good "$Global:HighGroups Groups Created"
    VulnAD-AddADGroup -GroupList $Global:MidGroups
    Write-Good "$Global:MidGroups Groups Created"
    VulnAD-AddADGroup -GroupList $Global:NormalGroups
    Write-Good "$Global:NormalGroups Groups Created"
    VulnAD-Acls
    Write-Good "ACL Done"
    VulnAD-Kerberoasting
    Write-Good "Kerberoasting Done"
    VulnAD-ASREPRoasting
    Write-Good "AS-REPRoasting Done"
    VulnAD-DnsAdmins
    Write-Good "DnsAdmins Done"
    VulnAD-DefaultPassword
    Write-Good "Leaked Password Done"
    VulnAD-PasswordSpraying
    Write-Good "Password Spraying Done"
    VulnAD-BadAcls
    Write-Good "Bad ACL Done"
    Write-Good "DCSync Done"
    VulnAD-DisableSMBSigning
    Write-Good "SMB Signing Disabled"
    VulnAD-EnableWinRM
    Write-Good "Windows Remote Management Enabled"
    VulnAD-AnonymousLDAP
    Write-Good "Anonymous LDAP Query Enabled"
    VulnAD-PublicSMBShare
    Write-Good "Created Public SMB Share"
    VulnAD-FirewallOff
    Write-Good "Firewall Turned Off"
	Write-Output "Restarting in 30 seconds..."
	Sleep 30; Restart-Computer
}

Invoke-VulnAD -UsersLimit 100 -DomainName "change.me"